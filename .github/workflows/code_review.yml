name: GPT Code Reviewer

on:
  push:
    branches:
      - main

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Get changed files
        id: files
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed.txt

      - name: Run GPT review
        run: |
          FILES=$(cat changed.txt)
          for FILE in $FILES; do
            echo "ðŸ“„ Reviewing $FILE"
            CONTENT=$(cat $FILE)
            echo "Review this code and suggest improvements:\n$CONTENT" > prompt.txt
            python3 -c "
import openai
openai.api_key = '${{ secrets.OPENAI_API_KEY }}'
p = open('prompt.txt').read()
res = openai.ChatCompletion.create(model='gpt-4', messages=[{'role': 'user', 'content': p}])
print(res['choices'][0]['message']['content'])
"
          done
